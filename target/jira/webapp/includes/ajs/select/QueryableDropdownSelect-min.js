AJS.QueryableDropdownSelect=AJS.Control.extend({INVALID_KEYS:{"Shift":true,"Esc":true,"Right":true},init:function(options){var instance=this;this._setOptions(options);this._queuedRequest=0;this.suggestionsVisible=false;if(this.options.ajaxOptions.minQueryLength){this.options.ajaxOptions.minQueryLength=parseInt(this.options.ajaxOptions.minQueryLength,10)}this._createFurniture();if(this.options.dropdownController){this.dropdownController=this.options.dropdownController}else{this.dropdownController=AJS.InlineLayer.create({offsetTarget:this.$field,width:this.$field.innerWidth(),content:options.element})}this.dropdownController.onhide(function(){instance.hideSuggestions()});this.listController=new AJS.List({containerSelector:options.element,groupSelector:"ul.aui-list-section",matchingStategy:this.options.matchingStategy,eventTarget:this.$field,selectionHandler:function(){instance.$field.val(AJS.I18n.getText("common.concepts.loading")).css("color","#999");instance.hideSuggestions();return true}});if(this.options.width){this.setFieldWidth(this.options.width)}this._assignEventsToFurniture();if(this.options.loadOnInit){this.suggestionsDisabled=true;this._requestThenResetSuggestions()}},setFieldWidth:function(width){this.$container.css({width:width,minWidth:width})},showErrorMessage:function(value){var $container=this.$container.parent(".field-group");this.hideErrorMessage();this.$errorMessage.text(AJS.format(this.options.errorMessage,value||this.getQueryVal()));if($container.length===1){$container.append(this.$errorMessage);return }if($container.length===0){$container=this.$container.parent(".frother-control-renderer")}if($container.length===1){this.$errorMessage.prependTo($container);return }if($container.length===0){this.$container.parent().append(this.$errorMessage)}},hideErrorMessage:function(){if(this.$errorMessage){this.$errorMessage.remove()}this.$container.parent().find(".error").remove()},_getDefaultOptions:function(){return{id:"default",ajaxOptions:{data:{},dataType:"json",minQueryLength:0},keyInputPeriod:75,localListLiveUpdateLimit:25,localListLiveUpdateDelay:150}},getAjaxOptions:function(){return AJS.copyObject(this.options.ajaxOptions)},issueRequest:function(){var instance=this,ajaxOptions=this.getAjaxOptions(),originalQuery=AJS.$.trim(this.getQueryVal());if(typeof ajaxOptions.data==="function"){ajaxOptions.data=ajaxOptions.data(originalQuery)}else{ajaxOptions.data.query=originalQuery}ajaxOptions.complete=function(xhr,textStatus,smartAjaxResult){instance.outstandingRequest=null;if(!instance.$container.is(":visible")){return }if(smartAjaxResult.successful){instance._handleServerSuccess(smartAjaxResult,originalQuery)}else{if(!smartAjaxResult.aborted){instance.hideSuggestions();instance._handleServerError(smartAjaxResult)}}};this.outstandingRequest=JIRA.SmartAjax.makeRequest(ajaxOptions);AJS.$(this.outstandingRequest).throbber({target:this.$dropDownIcon,isLatentThreshold:500})},_handleServerSuccess:function(smartAjaxResult,originalQuery){if(!AJS.isSelenium()&&!AJS.elementIsFocused(this.$field)){return }var freshQuery=this.getQueryVal()==originalQuery;if(freshQuery||!this.options.ajaxOptions.query||this.options.loadOnInit){this._handleServerSuggestions(smartAjaxResult.data,originalQuery);if(freshQuery){this.$container.attr("data-query",originalQuery)}}},_handleServerError:function(smartAjaxResult){var errMsg=JIRA.SmartAjax.buildSimpleErrorContent(smartAjaxResult,{alert:true});alert(errMsg)},_createFurniture:function(){this.$container=this._render("container").insertBefore(this.options.element);this.$field=this._render("field").appendTo(this.$container);this.$dropDownIcon=this._render("dropdownAndLoadingIcon",this._hasDropdownButton()).appendTo(this.$container);this.$suggestionsContainer=this._render("suggestionsContainer");if(this.options.overlabel){this.$overlabel=this._render("overlabel").insertBefore(this.$field);this.$overlabel.overlabel()}},_hasDropdownButton:function(){if(this.options.showDropdownButton===false){return false}else{if(this.options.showDropdownButton||this.options.ajaxOptions.minQueryLength===0){return true}}},_assignEventsToFurniture:function(){var instance=this;this._assignEvents("ignoreBlurElement",this.dropdownController.$layer);if(this._hasDropdownButton()){this._assignEvents("ignoreBlurElement",this.$dropDownIcon);this._assignEvents("dropdownAndLoadingIcon",this.$dropDownIcon)}setTimeout(function(){instance._assignEvents("field",instance.$field);instance._assignEvents("keys",instance.$field)},15)},_useCachedRequest:function(){return !!(this.cachedList&&!this.options.ajaxOptions.query)},_isValidRequest:function(){return this.options.ajaxOptions.query||(!this.cachedList&&!this.outstandingRequest)},_requestThenResetSuggestions:function(ignoreBuffer,query){var instance=this;this.listController._latestQuery=query||AJS.$.trim(this.getQueryVal());if(this._useCachedRequest()){this._handleServerSuggestions(this.cachedList)}else{if(this._isValidRequest()){if(ignoreBuffer&&this.outstandingRequest){this.outstandingRequest.abort();this.outstandingRequest=null}clearTimeout(this._queuedRequest);if(!this.outstandingRequest){this.issueRequest()}else{this._queuedRequest=setTimeout(function(){instance._requestThenResetSuggestions(ignoreBuffer)},this.options.keyInputPeriod)}}}},showSuggestions:function(){this._requestThenResetSuggestions(true)},_handleServerSuggestions:function(data,query){if(this.cachedList!==data){if(this._formatResponse){data=this._formatResponse(data,query)}else{if(this.options.ajaxOptions.formatResponse){data=this.options.ajaxOptions.formatResponse.call(this,data,query)}}this.cachedList=data}var context={groupId:this.options.serverDataGroupId,filter:!this.options.ajaxOptions.query};this._setSuggestions(this.cachedList,context)},_setSuggestions:function(data,context){if(this.suggestionsDisabled){this.suggestionsDisabled=false;return }this.suggestionsVisible=true;var query=this.getQueryVal();if(data){this.dropdownController.show();this.dropdownController.setWidth(this.$field.innerWidth());this.dropdownController.setPosition();context||(context={});context.query=query;if(typeof context.filter==="undefined"){context.filter=!!query}this.listController.generateListFromJSON(data,context);this.listController.enable()}else{this.hideSuggestions()}this.$container.attr("data-query",query)},getQueryVal:function(){return this.$field.val()},_isValidInput:function(event){return this.$field.is(":visible")&&!this.INVALID_KEYS[event.key]},_handleCharacterInput:function(ignoreBuffer,ignoreQueryLength){this.suggestionsDisabled=false;var query=AJS.$.trim(this.getQueryVal());var show=ignoreQueryLength||(query.length>=this.options.ajaxOptions.minQueryLength);if(show){var sendRequest=this.options.ajaxOptions.url&&!(this.options.ajaxOptions.noQueryNoRequest&&!query);if(sendRequest){this.$dropDownIcon.removeClass("noloading");this._requestThenResetSuggestions(ignoreBuffer)}var localDataGroupId=this.options.localDataGroupId;if(sendRequest&&!localDataGroupId){return }if(this.inlineBufferTimeout){clearTimeout(this.inlineBufferTimeout)}var data=this.model.getUnSelectedDescriptors({groupId:localDataGroupId});var context={groupId:localDataGroupId,filter:true};if(data.length>=this.options.localListLiveUpdateLimit){var instance=this;this.inlineBufferTimeout=setTimeout(function(){instance._setSuggestions(data,context)},this.options.localListLiveUpdateDelay)}else{this._setSuggestions(data,context)}}else{this._setSuggestions()}},_handleDown:function(e){if(!this.suggestionsVisible){this.listController._latestQuery="";this._handleCharacterInput(true,true)}},_rejectPendingRequests:function(){if(this.outstandingRequest){this.outstandingRequest.abort()}clearTimeout(this._queuedRequest)},hideSuggestions:function(){if(!this.suggestionsVisible){return }clearTimeout(this.inlineBufferTimeout);this._rejectPendingRequests();this.suggestionsVisible=false;this.$dropDownIcon.addClass("noloading");this.dropdownController.hide();this.listController.disable()},_deactivate:function(){this.hideSuggestions()},_handleEscape:function(e){if(this.suggestionsVisible){e.stopPropagation();if(e.type==="keyup"){this.hideSuggestions();if(AJS.$.browser.msie){this.$field.focus()}}}},acceptFocusedSuggestion:function(){var focused=this.listController.getFocused();if(focused.length!==0&&focused.is(":visible")){this.listController._acceptSuggestion(focused)}},keys:{"Down":function(e){if(this._hasDropdownButton()){this._handleDown(e)}},"Up":function(e){e.preventDefault()},"Return":function(e){e.preventDefault()}},onEdit:function(e){var instance=this;if(e.key==="\r"){return }this.$field.one("keyup",function(){instance._handleCharacterInput()})},_events:{dropdownAndLoadingIcon:{click:function(e){if(this.suggestionsVisible){this.hideSuggestions()}else{this._handleDown(e);this.$field.focus()}e.stopPropagation()}},field:{blur:function(){this._deactivate()},click:function(e){e.stopPropagation()},"keydown keyup":function(e){if(e.keyCode===27){this._handleEscape(e)}}},keys:{"aui:keydown aui:keypress":function(event){this._handleKeyEvent(event)}},ignoreBlurElement:{mousedown:function(e){var field=this.$field.get(0);function onbeforedeactivate(event){event.returnValue=false}if(typeof document.addEventListener==="undefined"){field.attachEvent("onbeforedeactivate",onbeforedeactivate);setTimeout(function(){field.detachEvent("onbeforedeactivate",onbeforedeactivate)},0)}else{e.preventDefault()}}}},_renders:{overlabel:function(){return AJS.$("<label id='"+this.options.id+"-label' for='"+this.options.id+"-field' class='overlabel'>"+this.options.overlabel+"</label>")},field:function(){return AJS.$("<input class='text' id='"+this.options.id+"-field' type='text' autocomplete='off' />")},container:function(){return AJS.$("<div class='queryable-select' id='"+this.options.id+"-queryable-container' />")},dropdownAndLoadingIcon:function(showDropdown){var $element=AJS.$('<span class="icon noloading"><span>More</span></span>');if(showDropdown){$element.addClass("drop-menu")}return $element},suggestionsContainer:function(){return AJS.$("<div class='aui-list' id='"+this.options.id+"' tabindex='-1'></div>")}}});AJS.namespace("AJS.QueryableDropdown",null,AJS.QueryableDropdownSelect);