AJS.MultiSelect=AJS.QueryableDropdownSelect.extend({init:function(options){var instance=this;if(this._setOptions(options)===this.INVALID){return this.INVALID}AJS.$(this.options.element).hide();if(this.options.disabled){this._createFurniture(true);return this}this.model=new AJS.SelectModel({element:this.options.element,removeOnUnSelect:this.options.removeOnUnSelect});this._createFurniture();this.dropdownController=AJS.InlineLayer.create({alignment:AJS.LEFT,offsetTarget:this.$field,maxInlineResultsDisplayed:this.options.maxInlineResultsDisplayed,content:AJS.$(".aui-list",this.$container)});this.dropdownController.onhide(function(){instance.hideSuggestions()});this.listController=new AJS.List({containerSelector:AJS.$(".aui-list",this.$container),groupSelector:"ul.aui-list-section",matchingStrategy:this.options.matchingStrategy,maxInlineResultsDisplayed:this.options.maxInlineResultsDisplayed,selectionHandler:function(e){instance._selectionHandler(this.getFocused(),e);return false}});this._assignEventsToFurniture();this.lozengeGroup=this.options.itemGroup;this._assignEvents("lozengeGroup",this.lozengeGroup);if(this.options.width){this.setFieldWidth(this.options.width)}this._restoreSelectedOptions();this.model.$element.trigger("initialized",[this]);return this},_getDefaultOptions:function(){return AJS.$.extend(true,this._super(),{minRoomForText:50,errorMessage:AJS.I18n.getText("jira.ajax.autocomplete.error"),ajaxOptions:{minQueryLength:1},showDropdownButton:true,itemGroup:new AJS.MultiSelect.LozengeGroup(),itemBuilder:function(descriptor){return new AJS.MultiSelect.Lozenge({label:descriptor.label(),title:descriptor.title(),container:this.$selectedItemsContainer})}})},_createFurniture:function(disabled){var id=this.model.$element.attr("id");if(this.model.$element.prev().hasClass("ajs-multi-select-placeholder")){this.model.$element.prev().remove()}if(disabled){this.model.$element.replaceWith(this._render("disableSelectField",id))}else{this.$container=this._render("container",id);this.$field=this._render("field",id).appendTo(this.$container);this.$container.append(this._render("suggestionsContainer",id));this.$container.insertBefore(this.model.$element);this.$dropDownIcon=this._render("dropdownAndLoadingIcon",this._hasDropdownButton()).appendTo(this.$container);this.$errorMessage=this._render("errorMessage");this.$selectedItemsWrapper=this._render("selectedItemsWrapper").appendTo(this.$container);this.$selectedItemsContainer=this._render("selectedItemsContainer").appendTo(this.$selectedItemsWrapper)}},_assignEventsToFurniture:function(){this._super();this._assignEvents("body",document);this._assignEvents("selectedItemsContainer",this.$selectedItemsContainer)},_getUserInputValue:function(){return this.options.uppercaseUserEnteredOnSelect?this.$field.val().toUpperCase():this.$field.val()},_handleUserInputOption:function(){var groupDescriptor;if(!this.hasUserInputtedOption()||this.$field.val().length===0){return }groupDescriptor=new AJS.GroupDescriptor({type:"optgroup",label:"user inputted option",weight:9999,showLabel:false,replace:true});groupDescriptor.addItem(new AJS.ItemDescriptor({value:this._getUserInputValue(),label:this.$field.val(),labelSuffix:" ("+this.options.userEnteredOptionsMsg+")",title:this.$field.val(),allowDuplicate:false,noExactMatch:true}));this.model.appendOptionsFromJSON([groupDescriptor])},hasUserInputtedOption:function(){return this.options.userEnteredOptionsMsg},_handleServerSuggestions:function(data){if(this.options.ajaxOptions.query){this.model.clearUnSelected()}this._handleUserInputOption();this._super(data)},_setSuggestions:function(data,context){if(data){this.model.appendOptionsFromJSON(data);data=this.model.getUnSelectedDescriptors();this._super(data,context)}else{this.hideSuggestions()}},clear:function(){this.$field.val("");this._handleCharacterInput(true);this.clearSelection()},clearSelection:function(){this.model.setAllUnSelected();this.updateItemsIndent();this.model.$element.trigger("unselect",[this])},removeItem:function(descriptor){var instance=this;this.model.setUnSelected(descriptor);window.setTimeout(function(){instance.updateItemsIndent()},0);this.model.$element.trigger("unselect",[descriptor,this])},_restoreSelectedOptions:function(){var instance=this;AJS.$.each(this.model.getSelectedDescriptors(),function(){instance.addItem(this)});this.updateItemsIndent()},_shouldEnableLozengeGroup:function(){return this.lozengeGroup.items.length>0&&this.lozengeGroup.index<0&&(this.$field.val().length===0||this.getCaret(this.$field[0])===0)},_handleBackSpace:function(){var instance=this;if(this._shouldEnableLozengeGroup()){setTimeout(function(){instance.lozengeGroup.shiftFocus(-1)},0)}else{this.$field.one("keyup",function(){instance._handleCharacterInput()})}},_handleDelete:function(){if(AJS.$.trim(this.$field.val())!==""){var instance=this;this.$field.one("keyup",function(){instance._handleCharacterInput()})}},_handleLeft:function(){if(this._shouldEnableLozengeGroup()){var instance=this;setTimeout(function(){instance.lozengeGroup.shiftFocus(-1)},0)}},_handlePaste:function(){this.$field.val(AJS.$.trim(this.$field.val()).replace(/\s+/g," "));this._handleCharacterInput()},updateItemsIndent:function(){var inputIndent=this._getInputIndent();this.$field.css({paddingTop:inputIndent.top,paddingLeft:inputIndent.left});this.$field.css({height:inputIndent.top+20});if(this.currentTopOffset&&this.currentTopOffset!==inputIndent.top){this.$container.trigger("multiSelectHeightUpdated",[this])}if(AJS.$.browser.msie){this.$field.val(this.$field.val()+" ");this.$field.val(this.$field.val().replace(/\s$/,""))}this.currentTopOffset=inputIndent.top},_isItemPresent:function(descriptor){var duplicate=false;var value=descriptor.value();AJS.$.each(this.lozengeGroup.items,function(){if(this.value===value){duplicate=true;return false}});return duplicate},addItem:function(descriptor){if(descriptor instanceof AJS.ItemDescriptor){descriptor=AJS.copyObject(descriptor.allProperties(),false)}descriptor.value=AJS.$.trim(descriptor.value);descriptor.label=AJS.$.trim(descriptor[this.options.itemAttrDisplayed])||descriptor.value;descriptor.title=AJS.$.trim(descriptor.title)||descriptor.label;descriptor=new AJS.ItemDescriptor(descriptor);if(this._isItemPresent(descriptor)){return }var lozenge=this.options.itemBuilder.call(this,descriptor);this.lozengeGroup.addItem(lozenge);this._assignEvents("lozenge",lozenge);this.model.setSelected(descriptor);this.updateItemsIndent();this.dropdownController.setPosition();lozenge.value=descriptor.value();this.model.$element.trigger("selected",[descriptor,this])},_addMultipleItems:function(items,removeOnUnSelect){var instance=this;AJS.$.each(items,function(i,descriptor){if(removeOnUnSelect){descriptor.removeOnUnSelect=true}instance.addItem(descriptor)})},_getTargetItemContainerWidth:function(){var lozenges=this.lozengeGroup.items,width=parseInt(this.$selectedItemsContainer.css("paddingLeft"),10)+parseInt(this.$selectedItemsContainer.css("paddingRight"),10);for(var i=lozenges.length-1;i>=0;i--){var $item=lozenges[i].$lozenge;width=width+$item.outerWidth()+parseInt($item.css("marginLeft"),10)+parseInt($item.css("marginRight"),10)}return width},_getInputIndent:function(){var top,left,iconArea=21,paddingLeft=2,paddingTop=3,indent={top:paddingTop,left:paddingLeft},lastLozengeIndex=this.lozengeGroup.items.length-1,$last;if(lastLozengeIndex>=0){$last=this.lozengeGroup.items[lastLozengeIndex].$lozenge;top=$last.attr("offsetTop");left=$last.attr("offsetLeft")+$last.outerWidth();if(left>this.$container.width()-iconArea-this.options.minRoomForText){top+=$last.attr("offsetHeight");left=0}indent.top+=top;indent.left+=left}return indent},_selectionHandler:function(selected,e){var instance=this;selected.each(function(){instance.addItem(AJS.$.data(this,"descriptor"))});this.$field.val("").focus().scrollIntoView({margin:20});this.hideSuggestions();this.hideErrorMessage();this.model.$element.trigger("change");e.preventDefault()},isValidItem:function(itemValue){var suggestedItemDescriptor=this.listController.getFocused().data("descriptor");if(!suggestedItemDescriptor){return false}itemValue=itemValue.toLowerCase();return itemValue===AJS.$.trim(suggestedItemDescriptor.label.toLowerCase())||itemValue===AJS.$.trim(suggestedItemDescriptor.value.toLowerCase())},handleFreeInput:function(){var value=AJS.$.trim(this.$field.val()),descriptor;if(value){descriptor=this.model.getDescriptor(value);if(descriptor){this.addItem(descriptor);this.model.$element.trigger("change")}else{this.showErrorMessage(value);return }}this.hideErrorMessage();this.$field.val("")},submitForm:function(){if(this.$field.val().length===0&&!this.suggestionsVisible){AJS.$(this.$field[0].form).submit()}},_deactivate:function(){this.handleFreeInput();this.lozengeGroup.trigger("blur");this.hideSuggestions()},keys:{"Left":function(){this._handleLeft()},"Backspace":function(){this._handleBackSpace()},"Del":function(){this._handleDelete()},"Return":function(e){this.submitForm();e.preventDefault()},"Tab":function(e){this.acceptFocusedSuggestion()}},_events:{body:{tabSelect:function(){if(this.$field.is(":visible")){this.updateItemsIndent()}},bulkTabSelect:function(){if(this.$field.is(":visible")){this.updateItemsIndent()}}},field:{paste:function(){setTimeout(AJS.$.proxy(this,"_handlePaste"),0)},"aui:keydown aui:keypress":function(event){if(this.lozengeGroup.index>=0){if(event.key in this.lozengeGroup.keys){event.preventDefault()}else{if(event.key==="Return"){this.submitForm();event.preventDefault()}else{this.onEdit(event);this.lozengeGroup.trigger("blur")}}}},click:function(){this.lozengeGroup.trigger("blur");this.$field.focus()}},lozengeGroup:{focus:function(){this.$field.focus();this.hideSuggestions();this._unassignEvents("keys",this.$field)},blur:function(){this._assignEvents("keys",this.$field);if(this.$field.val()){this._handleCharacterInput()}}},lozenge:{remove:function(event){this.removeItem(this.model.getDescriptor(event.target.value))}},selectedItemsContainer:{click:function(event){if(event.target===event.currentTarget){this.lozengeGroup.trigger("blur");this.$field.focus()}}}},_renders:{errorMessage:function(){return AJS.$('<div class="error" />')},selectedItemsWrapper:function(){return AJS.$('<div class="representation"></div>')},selectedItemsContainer:function(){return AJS.$('<ul class="items" />')},field:function(idPrefix){return AJS.$('<textarea autocomplete="off" id="'+idPrefix+'-textarea" class="aui-field" wrap="off"></textarea>')},disableSelectField:function(id){return AJS.$("<input type='text' class='long-field' name='"+id+"' id='"+id+"' />")},container:function(idPrefix){return AJS.$('<div class="multi-select" id="'+idPrefix+'-multi-select">')},suggestionsContainer:function(idPrefix){return AJS.$('<div class="aui-list" id="'+idPrefix+'-suggestions" tabindex="-1"></div>')}}});