AJS.Shortener=Class.extend({_getDefaultOptions:function(){return{items:"a, span",numRows:1,shortenText:"hide",shortenOnInit:true,persist:true}},init:function(options){var that=this,timer=null;if(typeof options==="string"){options={element:options}}options=options||{};this.options=AJS.$.extend(this._getDefaultOptions(),options);this.$container=AJS.$(this.options.element);this.$container.css({padding:0,display:"block"});if(this._isShortenedOnLoad()){this.shorten()}else{this.expand()}AJS.$(window).resize(function(){if(!that.expanded&&timer===null){that.timer=setTimeout(function(){that.shorten();that.timer=null},100)}})},_isShortenedOnLoad:function(){var cookieValue=localStorage.getItem("shorten-"+this.$container.attr("id"));if(cookieValue==="hidden"){return true}else{if(cookieValue==="shown"){return false}else{if(this.options.shortenOnInit){return true}}}return false},_renders:{ellipsis:function(itemsHidden){return AJS.$("<a href='#' class='ellipsis'>("+(itemsHidden)+")</a><br />")},shortenTip:function(removeText){return AJS.$("<a title='Hide' class='icon icon-hide' href='#'><span>"+removeText+"</span></a>")}},_removeEllipsis:function(){if(this.$ellipsis){this.$ellipsis.remove();this.$ellipsis=null}},_hasEllipsisWrapped:function(){return this.$ellipsis.attr("offsetTop")>this.$ellipsis.prev().attr("offsetTop")},_insertEllipsis:function(tryInsertAfter,itemsHidden){var that=this,insertAfterCount=tryInsertAfter;this.$ellipsis=this._renders.ellipsis(itemsHidden).insertAfter(this.$items[insertAfterCount]);if(insertAfterCount!==0&&this._hasEllipsisWrapped()){insertAfterCount--;that._removeEllipsis();that.$ellipsis=that._renders.ellipsis(itemsHidden+1).insertAfter(this.$items[insertAfterCount])}this.$ellipsis.click(function(e){e.preventDefault();that.expand()});return insertAfterCount},shorten:function(moveToShortened){function hasWrapped(){if(i<that.$items.length-1){return that.$items[i].offsetTop<that.$items[i+1].offsetTop||that.$items[i].offsetLeft>that.$items[i+1].offsetLeft||that.$items[i].realHeight>that.$items[i+1].realHeight+5}else{return that.$items[i].offsetTop>that.$items[i-1].offsetTop||that.$items[i].offsetLeft<that.$items[i-1].offsetLeft||that.$items[i].realHeight>that.$items[i-1].realHeight+5}}var availableRows=this.options.numRows,i=0,rows=0,containerheight=0,ellipseIndex=0,that=this;this._removeEllipsis();if(this.$shortenTip){this.$shortenTip.remove()}this.$items=this.$container.children(this.options.items);this.$items.each(function(){if(this.offsetHeight!==0){this.realHeight=this.offsetHeight}else{this.realHeight=AJS.$(this).children(that.options.items).attr("offsetHeight")||0}});if(this.$items.length<2){return }this.$container.css({overflow:"hidden"});do{if(hasWrapped()){rows++;if(rows===availableRows){if(i===0){ellipseIndex=that._insertEllipsis(0,this.$items.length-1)}else{ellipseIndex=that._insertEllipsis(i-1,this.$items.length-i)}containerheight=(this.$items[ellipseIndex].offsetTop-that.$items[0].offsetTop);containerheight+=this.$items[ellipseIndex].realHeight;if((that.$items[ellipseIndex].offsetTop)<this.$ellipsis[0].offsetTop){containerheight+=this.$ellipsis[0].offsetHeight+(this.$ellipsis[0].offsetTop-that.$items[ellipseIndex].offsetTop-this.$items[ellipseIndex].realHeight)}that.$container.height(containerheight+3);break}else{if(i===0){availableRows=availableRows+1}}}i++}while(this.$items[i]);if(this.options.persist){localStorage.setItem("shorten-"+this.$container.attr("id"),"hidden")}if(moveToShortened){this.$container.scrollIntoView()}if(jQuery.browser.msie&&jQuery.browser.version>=8&&jQuery.browser.version<9){AJS.$("body").addClass("reflow")}delete this.expanded},expand:function(){function canBeShortened(){return that.$items[0].offsetTop<that.$items[that.$items.length-1].offsetTop||(that.$items[0].realHeight*2)<that.$container[0].offsetHeight}var that=this;this.expanded=true;this._removeEllipsis();this.$items=AJS.$(this.$container.children(this.options.items));this.$items.each(function(){if(this.offsetHeight!==0){this.realHeight=this.offsetHeight}else{this.realHeight=AJS.$(this).children(that.options.items)[0].offsetHeight}});this.$container.css({height:"",overflow:""});if(this.$items.length>1&&canBeShortened()){this.$shortenTip=this._renders.shortenTip(this.options.shortenText);this.$shortenTip.appendTo(this.$container).click(function(e){that.shorten(true);e.preventDefault()})}if(this.options.persist){localStorage.setItem("shorten-"+this.$container.attr("id"),"shown")}if(jQuery.browser.msie){AJS.$("body").addClass("reflow")}}});jQuery.fn.shorten=function(options){var res=[];options=options||{};this.each(function(){options.element=this;res.push(new AJS.Shortener(options))});return res};